# 3 Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## 3.1 Monthly Real Retail Turnover Index EDA

<br>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

little explanation of what we're show to see with the data

</div>

<br>


```{r, fig.align='center'}
ts %>% autoplot(tot)
```

```{r, fig.align='center'}
ts %>% ACF(tot) %>% autoplot()
ts %>% features(tot, feat_acf)
```

```{r, fig.align='center'}
ts %>% gg_lag(tot, geom = "point")
```









```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(tot, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(tot, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:

ts %>% gg_season(tot)

# We can notice from the season plot that December is the month with the highest index of sales,
# On the other hand, every year in February sales sink compared to January for almost every year of the time series.
# Moreover, in March, May and July the sales increase after declining for the months of April and June. Interesting
# also to notice that from August until the end of the year the sales increase following something similar to a linear trend.
```


```{r, fig.align='center'}
ts %>% autoplot(food_bev_tobacco_retail)
```


```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(food_bev_tobacco_retail, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(food_bev_tobacco_retail, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(food_bev_tobacco_retail)
```

```{r, fig.align='center'}
ts %>% autoplot(`non-food_without_service_stations`)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(`non-food_without_service_stations`, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(`non-food_without_service_stations`, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(`non-food_without_service_stations`)
```


```{r, fig.align='center'}
ts %>% autoplot(information_communication_equipment)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(information_communication_equipment, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(information_communication_equipment, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(information_communication_equipment)
```

```{r, fig.align='center'}
ts %>% autoplot(other_household_equipment)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(other_household_equipment, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(other_household_equipment, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(other_household_equipment)
```

```{r, fig.align='center'}
ts %>% autoplot(cultural_recreation)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(cultural_recreation, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(cultural_recreation, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(cultural_recreation)
```

```{r, fig.align='center'}
ts %>% autoplot(other_goods)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(other_goods, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(other_goods, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(other_goods)
```

```{r, fig.align='center'}
ts %>% autoplot(`478:479`)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(`478:479`, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(`478:479`, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(`478:479`)
```

```{r, fig.align='center'}
ts %>% autoplot(service_stations)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(service_stations, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(service_stations, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(service_stations)
```

```{r, fig.align='center'}
ts %>% autoplot(tot_without_fuel)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(tot_without_fuel, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(tot_without_fuel, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(tot_without_fuel)
```

```{r, fig.align='center'}
ts %>% autoplot(clothing_footwear)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(clothing_footwear, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(clothing_footwear, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(clothing_footwear)
```

```{r, fig.align='center'}
ts %>% autoplot(auto_fuel)
```

```{r, fig.align='center'}
# Classical decomposition
# Classical decomposition additive
ts %>% 
  model(classical_decomposition(auto_fuel, type = "additive")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
# Classical decomposition multiplicative
ts %>%
  model(classical_decomposition(auto_fuel, type = "multiplicative")) %>%
  components() %>%
  autoplot() +
  xlab("Years")
```

```{r, fig.align='center'}
# Let's check the seasonality:
ts %>% gg_season(auto_fuel)
```

# EDA on covid dataset and consumer expectation

```{r, fig.align='center'}
# covid

covid<- cov_date %>%
  mutate(hospital_cases = as.numeric(`Nombre de cas hospitalisés`),
         deaths = as.numeric(`Nombre de décés`)) %>%
  select(year_day,hospital_cases,deaths) %>%
  as_tsibble()

# Plot on hospital cases:

autoplot(covid)

# Plot on deaths cases

covid %>%
  autoplot(deaths)



# consumer expectations
# is i63_index the total index?
 cons_raw_ts %>%
  as_tsibble() %>%
  autoplot(i63_index)

cons_raw_ts %>%
  as_tsibble() %>%
  autoplot(i12_econ_exp)

# The index seems to follow the economic expectation

```


```{r, fig.align='center'}

# wrangling for the merge
# merge dataset about retail sales and consumer expectation ( I assume that it is the column i63_index but not totally sure about that in the case do modifications)

consumer_dataset <- cons_raw_ts %>% 
  select( ...16, i63_index) %>% 
  rename( year_month = ...16, consumer_index = i63_index ) %>% 
  as_tsibble()

merge_try <- merge(ts, consumer_dataset )

# Correlation structure analysis:
# inspect correlation between tot. sales and the first 8 columns
merge_try %>% GGally::ggpairs(2:8)

# inspect correlation between tot. sales and the last 6 columns
merge_try %>% GGally::ggpairs(c(2,9,10,11,12,13,14))

# inspect correlation between consumer index and tot retail sales
merge_try %>% GGally::ggpairs(c(2,15))

# slight negative correlation ( as expected ) 

# correlations covid

covid  %>% GGally::ggpairs(2:3)

# hospital cases and deaths are highly correlated ( obviously ).

# creating monthly observations for covid dataset ( not daily)
covid_monthly <-
covid %>%
  mutate(year_month = yearmonth(year_day)) %>%
  as_tibble() %>%
  group_by(year_month) %>%
  summarise(hospital_cases = sum(hospital_cases),
            deaths = sum(deaths))  %>%
  tsibble()



new_dataset <- merge(covid_monthly,merge_try)


# Let's see correlations in 2020

new_dataset %>% GGally::ggpairs(2:4)
# no significative correlation between covid cases and sales

new_dataset %>% GGally::ggpairs(c(2:4,17))

# No significant results

```









## beginning of analysis

```{r, fig.align='center'}
# Exponential smoothing forecasting

fit_ETS <- ts %>%
  model(ETS(tot))

fit_ETS %>%
  report()

# The default function gives an ETS with multiplicative errors, additive trend with dampening and a multiplicative seasonality.

fit_ETS %>% forecast(h = 10) %>% autoplot(ts)
```

```{r, fig.align='center'}
# Let's apply an additive model
fit_ETS2 <- ts %>%
  model(ETS(tot ~ error("A") + trend("Ad")  + season("A")))

fit_ETS2 %>%
  report()

fit_ETS2 %>% forecast( h= 10) %>% autoplot(ts)

# Compare the accuracy between the 2 models:

accuracy(fit_ETS)
accuracy(fit_ETS2)

# The multiplicative model seems to be better.
```

```{r, fig.align='center'}
# Regression model with trend and season

fit_reg <- ts %>%
  model(TSLM(tot ~ trend() + season()))

report(fit_reg)

# Just to have a picture of the predictions and the actual data

augment(fit_reg) %>% ggplot(aes(x = year_month)) +
  geom_line(aes(y = tot, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted"))

# Check for the accuracy:

accuracy(fit_reg)

#It is not improved in relation with the previous ETS model.
```

```{r, fig.align='center'}
# As we know that the seasonality is probably slightly multiplicative log transfor the model

fit_regl <- ts %>%
  model(TSLM = TSLM(log(tot)~ trend() + season()))

augment(fit_regl)

tidy(fit_regl) %>% select(term, estimate)

expcoef <- (exp(coef(fit_regl)$estimate) - 1) * 100
options( scipen = 999)
expcoef

# Every month the sales increase by 7,2 %

fit_regl %>% forecast(h = 48) %>% autoplot(ts)

# compare reg model and log reg model:

accuracy(fit_regl)
accuracy(fit_reg)

# The reg model seems better.
```

```{r, fig.align='center'}
fit_arima <- ts %>% model(ARIMA(tot))
## A mable: 1 x 1
               #`ARIMA(tot)`
                   # <model>
#1 <ARIMA(2,1,2)(0,1,2)[12]>
accuracy(fit_arima)
forecast(fit_arima, h = 48) %>% autoplot(ts)
```

```{r, fig.align='center'}
# Comparison between different models:

fit_multi_models <- ts %>% 
  model(
  stepwise = ARIMA(tot),
  search = ARIMA(tot, stepwise = FALSE),
  expsmooth = ETS(tot),
  TSLM = TSLM(log(tot)~ trend() + season()
  ))


glance(fit_multi_models) %>%  arrange(AICc) %>% select(1:7)


fit_multi_models %>% forecast(h=48) %>% 
  autoplot(ts)

# not very useful visualization

# Theoretically the best model:
# 1 minute to run

fit_best <- ts %>% 
  model(best = ARIMA(tot, stepwise = FALSE,approximation = FALSE))

fit_best %>% forecast(h = 48) %>% autoplot(ts)

accuracy(fit_best)
accuracy(fit_arima)


# regression with 3 different regressors

fit_reg2 <- new_dataset %>%
  as_tsibble()  %>%
  model(reg = TSLM(tot ~  hospital_cases + deaths + consumer_index))

report(fit_reg2)

# We see that probably consumer index and deaths are not good predictors

accuracy(fit_reg2)
accuracy(fit_reg)
```


```{r, fig.align='center'}
# We want to answer the following research question: which is the subseries that has benefit more from covid and the one that did worse during covid period.


# Start giving an overlook to the subseries and how they behaved in the first months of 2020
# Forecasts for sub series sectors:

# the problem with these predictions is that in the next few months ( march, april..) the covid situation had became worse. So the ETS model is not fully reliable, we have to include into the forecast the information about covid.

# tot_without_service_station

ts_twss <- ts %>%
  model(ETS(totwithout_service_stations))  
report(ts_twss)
a<- ts_twss %>% forecast(h=24) %>% autoplot(ts)

# food_bev_tobacco

ts_fbt <- ts %>%
  model(ETS(food_bev_tobacco_retail))  
report(ts_fbt)
b <-ts_fbt %>% forecast(h=24) %>% autoplot(ts)

# Non-food_without_service_station

ts_nfwss<- ts %>%
  model(ETS(`non-food_without_service_stations`))  
report(ts_nfwss)

c <-ts_nfwss %>% forecast(h=24) %>% autoplot(ts)

# information_communication_equipment

ts_ice <- ts %>%
  model(ETS(information_communication_equipment))

forecast_ice <- ts_ice %>% forecast(h=24)

d <- ts_ice %>% forecast(h=24) %>% autoplot(ts)
# other_household_equipment

ts_ohe <- ts %>%
  model(ETS(other_household_equipment))

e <-ts_ohe %>% forecast(h=24) %>% autoplot(ts)

# cultural recreation
ts_cr <- ts %>%
  model(ETS(cultural_recreation))

report(ts_cr)
f <-ts_cr %>% forecast(h= 24) %>% autoplot(ts)

#other goods

ts_og <- ts %>%
  model(ETS(other_goods))

g <-ts_og %>% forecast(h= 24) %>% autoplot(ts)

# 478:479 (?)

ts_478_479 <- ts %>%
  model(ETS(`478:479`))

h <-ts_478_479 %>% forecast(h= 24) %>% autoplot(ts)

# service station
ts_ss <- ts %>%
  model(ETS(service_stations))

i <-ts_ss %>% forecast(h= 24) %>% autoplot(ts)


# tot_without fuel
ts_twf <- ts %>%
  model(ETS(tot_without_fuel))

j <-ts_twf %>% forecast(h= 24) %>% autoplot(ts)

# clothing_footwear

ts_cf <- ts %>%
  model(ETS(clothing_footwear))

k <- ts_cf %>% forecast(h= 24) %>% autoplot(ts)

# autofuel
ts_af <- ts %>%
  model(ETS(auto_fuel))  
report(ts_af)
l<- ts_af %>% forecast(h=24) %>% autoplot(ts)

# not really fancy to see
(a/b/c/d)
(e/f/g/h)
(i/j/k/l)
```
```{r, fig.align='center'}
# Create dataset with important sub series:

ts_new <- ts %>%
  select(year_month,food_bev_tobacco_retail,information_communication_equipment,other_household_equipment,
         cultural_recreation)

# we want to cut the sub series from march 2020 onwards
ts_cut <- ts_new %>% head(242)

# FOOD_BEV_TOBACCO_RETAIL

ts_cut_1 <- ts_cut %>%
  model(ARIMA(food_bev_tobacco_retail))

# forecast from march to february 2021.
for_nocov<-ts_cut_1 %>% forecast(h=12) %>% autoplot(ts_cut)
accuracy(ts_cut_1)

for_cov<- ts %>% autoplot(food_bev_tobacco_retail)

# comparison

for_nocov/for_cov

# INFORMATION COMMUNICATION EQUIPMENT

ts_cut_2 <- ts_cut %>%
  model(ARIMA(information_communication_equipment))
accuracy(ts_cut_2)
# forecast from march to february 2021
for_nocov2<-ts_cut_2 %>% forecast(h=12) %>% autoplot(ts_cut)

for_cov2 <- ts %>% autoplot(information_communication_equipment)

#comparison
for_nocov2/ for_cov2

# OTHER HOUSEHOLD
ts_cut_3 <- ts_cut %>%
  model(ARIMA(other_household_equipment))
accuracy(ts_cut_3)

# forecast from march to february 2021
for_nocov3<-ts_cut_3 %>% forecast(h=12) %>% autoplot(ts_cut)

for_cov3 <- ts %>% autoplot(other_household_equipment)

for_nocov3/ for_cov3


# CULTURAL RECREATION
ts_cut_4 <- ts_cut %>%
  model(ARIMA(cultural_recreation))
  
# forecast from march to february 2021
for_nocov4<-ts_cut_4 %>% forecast(h=12) %>% autoplot(ts_cut)

for_cov4 <- ts %>% autoplot(cultural_recreation)

for_nocov4/ for_cov4


# Let's see if with covid data improve the results:

s<- merge(covid_monthly,ts_new,by="year_month")
#DOES NOT WORK
# create 

ts_new_cov <- ts_new %>%
  mutate(Hospital_Cases = 0) 

ts_new_cov[c(242,243,244,245,246,247,248,249,250,251,252,253,254),6] <- c(42,2763,1108,111,59,222,219,454,3552,5947,5035,3004,1279) 


# Forecasting With arima taking into account Hospital_cases to see whether the accuracy increase

# data splitting

training <- subset(ts_new_cov[1:242,])
test <- subset(ts_new_cov[243:254,])

model_fit <- training %>%
  model(ARIMA(food_bev_tobacco_retail~ Hospital_Cases))


